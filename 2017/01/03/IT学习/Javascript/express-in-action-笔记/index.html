<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>express-in-action_笔记 | 元素力量 | 铁钴镍铜锌</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="nodejs,javascript,express">
  <meta name="description" content="第一部分 简介第一章 基本概念关键词: node.js express
第一章主要回答了以下几个问题。

什么是Node.js:依赖于 Google V8 引擎，使 javascript 脱离浏览器，运行在服务端。

Node.js的优势:

V8 引擎很快，尤其是面对异步和多线程；
JS 流行已久，资源丰富；
客户端与服务端可共享代码。


为什么用Node.js不是拍脑袋，不是为了性能，是为了">
<meta property="og:type" content="article">
<meta property="og:title" content="express-in-action_笔记">
<meta property="og:url" content="http://tonglei.win/2017/01/03/IT学习/Javascript/express-in-action-笔记/index.html">
<meta property="og:site_name" content="元素力量">
<meta property="og:description" content="第一部分 简介第一章 基本概念关键词: node.js express
第一章主要回答了以下几个问题。

什么是Node.js:依赖于 Google V8 引擎，使 javascript 脱离浏览器，运行在服务端。

Node.js的优势:

V8 引擎很快，尤其是面对异步和多线程；
JS 流行已久，资源丰富；
客户端与服务端可共享代码。


为什么用Node.js不是拍脑袋，不是为了性能，是为了">
<meta property="og:updated_time" content="2017-02-21T02:26:28.331Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="express-in-action_笔记">
<meta name="twitter:description" content="第一部分 简介第一章 基本概念关键词: node.js express
第一章主要回答了以下几个问题。

什么是Node.js:依赖于 Google V8 引擎，使 javascript 脱离浏览器，运行在服务端。

Node.js的优势:

V8 引擎很快，尤其是面对异步和多线程；
JS 流行已久，资源丰富；
客户端与服务端可共享代码。


为什么用Node.js不是拍脑袋，不是为了性能，是为了">
  
    <link rel="alternative" href="/atom.xml" title="元素力量" type="application/atom+xml">
  
  <meta name="summary" content="null">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/img/logo.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">铜镭</h5>
        <a href="mailto:me@tonglei.win" title="me@tonglei.win" class="mail">me@tonglei.win</a>
      </hgroup>
    </div>
  </div>
  <div class="scroll-wrap flex-col">
    <ul class="nav">
      
          <li class="waves-block waves-effect">
            <a href="/"  >
              <i class="icon icon-lg icon-home"></i>
              主页
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/archives"  >
              <i class="icon icon-lg icon-archives"></i>
              归档
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/favsites"  >
              <i class="icon icon-lg icon-fighter-jet"></i>
              咻～
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="https://github.com/tonglei0429" target="_blank" >
              <i class="icon icon-lg icon-github"></i>
              Github
            </a>
          </li>
      
    </ul>

    <footer class="footer">
  <p>元素力量 &copy; 2017</p>
  <p>用的是<a href="http://hexo.io/" target="_blank">Hexo</a> 主题改的<a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

  </div>
</div>

  </nav>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">express-in-action_笔记</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">express-in-action_笔记</h1>
    <h5 class="subtitle">
        
            <time datetime="2017-01-03T09:07:49.000Z" itemprop="datePublished" class="page-time">
  2017-01-03
</time>


	<a class="article-category-link" href="/categories/IT学习/">IT学习</a> > <a class="article-category-link" href="/categories/IT学习/Javascript/">Javascript</a>

        
    </h5>
	<div style="position:absolute;">
		<iframe src="https://ghbtns.com/github-btn.html?user=tonglei0429&repo=me&type=star&size=small&count=true" frameborder="0" scrolling="0" width="80" height="20"></iframe>
		<iframe src="https://ghbtns.com/github-btn.html?user=tonglei0429&type=follow&size=small" frameborder="0" scrolling="0" width="150" height="20"></iframe>
	</div>
  </div>
  	
</header>

    <div class="container body-wrap">
      <article id="post-IT学习/Javascript/express-in-action-笔记" 
  class="article article-type-post" itemprop="blogPost">
    <div class="post-meta flex-row">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>

    </div>
    <div class="post-body">
        <aside class="post-widget" id="post-widget">

            
            <div class="post-share" id="post-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

            

            
            <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#第一部分-简介"><span class="post-toc-number">1.</span> <span class="post-toc-text">第一部分 简介</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第一章-基本概念"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">第一章 基本概念</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第二章-nodejs"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">第二章 nodejs</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第三章-expressjs"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">第三章 expressjs</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#第二部分-核心"><span class="post-toc-number">2.</span> <span class="post-toc-text">第二部分 核心</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第四章-中间件"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">第四章 中间件</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第五章-路由"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">第五章 路由</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第六章-构建-APIs"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">第六章 构建 APIs</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第七章-Views-and-templates-Pug-and-Ejs"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">第七章 Views and templates, Pug and Ejs</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#第三部分"><span class="post-toc-number">3.</span> <span class="post-toc-text">第三部分</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#MongoDB"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">MongoDB</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Express的测试"><span class="post-toc-number">4.</span> <span class="post-toc-text">Express的测试</span></a></li></ol>
            </nav>
            
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="第一部分-简介"><a href="#第一部分-简介" class="headerlink" title="第一部分 简介"></a>第一部分 简介</h1><h2 id="第一章-基本概念"><a href="#第一章-基本概念" class="headerlink" title="第一章 基本概念"></a>第一章 基本概念</h2><p><strong>关键词: node.js express</strong></p>
<p>第一章主要回答了以下几个问题。</p>
<ul>
<li><p>什么是Node.js:<br>依赖于 Google V8 引擎，使 javascript 脱离浏览器，运行在服务端。</p>
</li>
<li><p>Node.js的优势:</p>
<ol>
<li>V8 引擎很快，尤其是面对异步和多线程；</li>
<li>JS 流行已久，资源丰富；</li>
<li>客户端与服务端可共享代码。</li>
</ol>
</li>
<li><p>为什么用Node.js<br>不是拍脑袋，不是为了性能，是为了全栈开发。</p>
</li>
<li><p>什么是Express:<br>Express 就像 JQuery，封装了原生API，并易于扩展。</p>
</li>
<li><p>Express 的意义:</p>
<ol>
<li>为Node.js增加了不少使用的工具方法；</li>
<li>将请求重构分解，使其模块化，更易维护。</li>
</ol>
</li>
<li><p>Express 的哲学</p>
<ol>
<li>作为一个框架，express的形式并不严格，它适合各类应用，比如视频聊天、博客甚至API服务。</li>
<li>很少有应用可以仅仅依赖 express，你仍然需要大量的第三方软件包。</li>
<li>最简化是把双刃剑，它增加了寻找合适第三方的难度。</li>
</ol>
</li>
<li><p>Express 的四个核心特性</p>
<ol>
<li>中间件：把请求到响应的过程分解为一个个小模块；</li>
<li>路由：将请求地址和方法与中间件的函数对应起来；</li>
<li>子应用：大工程的组成单元，是小型的应用实体；</li>
<li>简化：就是简化了原生Node.js语法。</li>
</ol>
</li>
<li><p>Express 适合谁？</p>
<ol>
<li>适合Web应用</li>
<li>适合全栈开发人员</li>
<li>适合单页应用SPAs</li>
<li>SEAN / MEAN / MEN</li>
</ol>
</li>
</ul>
<h2 id="第二章-nodejs"><a href="#第二章-nodejs" class="headerlink" title="第二章 nodejs"></a>第二章 nodejs</h2><p><strong>关键词: nodejs</strong></p>
<p>第二章主要介绍的都是nodejs 的基本用法，例如 HelloWorld，使用模块等。</p>
<h2 id="第三章-expressjs"><a href="#第三章-expressjs" class="headerlink" title="第三章 expressjs"></a>第三章 expressjs</h2><p><strong>关键词: express</strong></p>
<p>第三章从express的四个特点方面给出了入门示例。</p>
<ul>
<li><p>中间件示例，增加认证能力</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">request, response, next</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"In comes a "</span> + request.method + <span class="string">" to "</span> + request.url);</div><div class="line">  next();</div><div class="line">&#125;);</div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">request, response, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> minute = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getMinutes();</div><div class="line">  <span class="keyword">if</span> ((minute % <span class="number">2</span>) === <span class="number">0</span>) &#123;</div><div class="line">    next();</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    response.statusCode = <span class="number">403</span>;</div><div class="line">    response.end(<span class="string">"Not authorized."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line">  response.end(<span class="string">'Secret info: the password is "swordfish"!'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>路由示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="keyword">var</span> publicPath = path.resolve(__dirname, <span class="string">"public"</span>);</div><div class="line">app.use(express.static(publicPath));</div><div class="line"></div><div class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line">  response.end(<span class="string">"Welcome to my homepage!"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.get(<span class="string">"/about"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line">  response.end(<span class="string">"Welcome to the about page!"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.get(<span class="string">"/weather"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line">  response.end(<span class="string">"The current weather is NICE."</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.get(<span class="string">"/hello/:who"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line"> response.end(<span class="string">"Hello, "</span> + request.params.who + <span class="string">"."</span>);</div><div class="line"> <span class="comment">// Fun fact: this has some security issues, which we’ll get to!</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line">  response.statusCode = <span class="number">404</span>;</div><div class="line">  response.end(<span class="string">"404!"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">http.createServer(app).listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>扩展原生 Request 和 Response</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"><span class="keyword">var</span> EVIL_IP = <span class="string">"192.168.1.1"</span>;</div><div class="line"><span class="keyword">var</span> REDIRECT_IP = <span class="string">"192.168.1.2"</span>;</div><div class="line"><span class="keyword">var</span> SEND_FILE_IP = <span class="string">"192.168.1.3"</span>;</div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">request, response, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (request.ip === EVIL_IP) &#123;</div><div class="line">    response.status(<span class="number">401</span>).send(<span class="string">"Not allowed!"</span>);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.ip === REDIRECT_IP) &#123;</div><div class="line">    response.redirect(<span class="string">"http://tonglei.win"</span>);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.ip === SEND_FILE_IP) &#123;</div><div class="line">    response.sendFile(<span class="string">"/path/to/cool_song.mp3"</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">// ... the rest of your app ...</span></div></pre></td></tr></table></figure>
</li>
<li><p>视图<br>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.set(<span class="string">"views"</span>, path.resolve(__dirname, <span class="string">"views"</span>));</div><div class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"ejs"</span>);</div><div class="line"></div><div class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line">  response.render(<span class="string">"index"</span>, &#123;</div><div class="line">    <span class="attr">message</span>: <span class="string">"Hey everyone! This is my webpage."</span></div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>views/index.ejs<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">%=</span> <span class="attr">message</span> %&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h1 id="第二部分-核心"><a href="#第二部分-核心" class="headerlink" title="第二部分 核心"></a>第二部分 核心</h1><h2 id="第四章-中间件"><a href="#第四章-中间件" class="headerlink" title="第四章 中间件"></a>第四章 中间件</h2><p><strong>关键词: middleware, log, thrid part</strong></p>
<ul>
<li>Express 包含一个中间件的堆栈，除非中间返回或者出错，不然它会从头执行到底。</li>
<li>中间件是对 Request 的处理函数，它至少有2个参数: request 和 response，通常还有一个指向下一个中间件处理的方法。</li>
<li>网络上有各种成熟的第三方中间件。</li>
</ul>
<p>从这里可以找到很多网友提供的中间件<br><a href="http://expressjs.com/resources/middleware.html" target="_blank" rel="external">http://expressjs.com/resources/middleware.html</a></p>
<p>一个完整的例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// 本例始终返回一个文件</span></div><div class="line"><span class="keyword">var</span> filePath = path.join(__dirname, <span class="string">"celine.jpg"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 如果发送文件失败，进入异常处理。</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.sendFile(filePath, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Error sending file!"</span>));</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 打印错误日志</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.error(err);</div><div class="line">  next(err);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 返回错误页</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  res.status(<span class="number">500</span>);</div><div class="line">  res.send(<span class="string">"Internal server error."</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 启动 Http 监听</span></div><div class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"> <span class="built_in">console</span>.log(<span class="string">"App started on port 3000"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="第五章-路由"><a href="#第五章-路由" class="headerlink" title="第五章 路由"></a>第五章 路由</h2><p><strong>关键词 routing</strong></p>
<ul>
<li>简单的路由参数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.get(<span class="string">"/users/:userid"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> userId = <span class="built_in">parseInt</span>(req.params.userid, <span class="number">10</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li><p>正则表达式的路由参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.get(<span class="regexp">/^\/users\/(\d+)-(\d+)$/</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> startId = <span class="built_in">parseInt</span>(req.params[<span class="number">0</span>], <span class="number">10</span>);</div><div class="line">  <span class="keyword">var</span> endId = <span class="built_in">parseInt</span>(req.params[<span class="number">1</span>], <span class="number">10</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>使用 Https</p>
<ol>
<li><p>生成证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -out privatekey.pem 1024</div><div class="line">openssl req -new -key privatekey.pem -out request.pem</div></pre></td></tr></table></figure>
</li>
<li><p>Express 中使用证书</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">"https"</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"><span class="comment">// ... define your app ...</span></div><div class="line"><span class="keyword">var</span> httpsOptions = &#123;</div><div class="line">  <span class="attr">key</span>: fs.readFileSync(<span class="string">"path/to/private/key.pem"</span>),</div><div class="line">  <span class="attr">cert</span>: fs.readFileSync(<span class="string">"path/to/certificate.pem"</span>)</div><div class="line">&#125;;</div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.status(<span class="number">404</span>).render(<span class="string">"404"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">http.createServer(app).listen(<span class="number">80</span>);</div><div class="line">https.createServer(httpsOptions, app).listen(<span class="number">443</span>);</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<h2 id="第六章-构建-APIs"><a href="#第六章-构建-APIs" class="headerlink" title="第六章 构建 APIs"></a>第六章 构建 APIs</h2><p><strong>关键词: API, 主机间交互</strong></p>
<ul>
<li>一个简单的API样式</li>
</ul>
<p>请求方式：/timezone?tz=America+Los_Angeles</p>
<p>反馈结果：{ “time”: “2015-06-09T16:20:00+01:00”, “zone”: “America/Los_Angeles” }</p>
<ul>
<li>一个更完整的Express Api示例</li>
</ul>
<p>需求：</p>
<ol>
<li>API的调用需要传入一个最小值和一个最大值；</li>
<li>API返回一个随机数。</li>
</ol>
<p>实现步骤：</p>
<ol>
<li>创建package.json;</li>
<li>创建 app.js，作为程序入口;</li>
<li>在 app.js 中实现express路由，并返回随机数。</li>
</ol>
<p>代码：</p>
<ol>
<li><p>package.json</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"2-api-random"</span>,</div><div class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="string">"description"</span>: <span class="string">"Express实例2 构建简单的API"</span>,</div><div class="line">  <span class="string">"main"</span>: <span class="string">"app.js"</span>,</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"test"</span>: <span class="string">"node app.js"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"author"</span>: <span class="string">"Booker"</span>,</div><div class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line">app.get(<span class="string">'/random/:min/:max'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">  <span class="comment">// 获取参数</span></div><div class="line">  <span class="keyword">var</span> min = <span class="built_in">parseInt</span>(req.params.min);</div><div class="line">  <span class="keyword">var</span> max = <span class="built_in">parseInt</span>(req.params.max);</div><div class="line"></div><div class="line">  <span class="comment">// 错误处理</span></div><div class="line">  <span class="keyword">if</span>(<span class="built_in">isNaN</span>(min) || <span class="built_in">isNaN</span>(max)) &#123;</div><div class="line">    res.status(<span class="number">400</span>);</div><div class="line">    res.json(&#123;<span class="attr">error</span>: <span class="string">"Bad request."</span>&#125;);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result = <span class="built_in">Math</span>.round((<span class="built_in">Math</span>.random() * (max - min)) + min);</div><div class="line"></div><div class="line">  res.json(&#123;<span class="attr">result</span>: result&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'App started on port 3000'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>启动和测试<br>控制台输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm <span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>浏览器访问：<a href="http://localhost:3000/random/10/100" target="_blank" rel="external">http://localhost:3000/random/10/100</a><br>可以看到浏览器上的输出：{“result”:61}</p>
</li>
<li><p>对异常的处理</p>
<ol>
<li>设置http状态为400；</li>
<li>返回描述错误的 json 对象；</li>
<li>执行 return，如果没有此步，程序还会继续进行，还会产生其他错误。</li>
</ol>
<p>比如访问：<a href="http://localhost:3000/random/10/aaa" target="_blank" rel="external">http://localhost:3000/random/10/aaa</a><br>浏览器上输出：{“error”:”Bad request.”}</p>
</li>
</ol>
<ul>
<li><p>CRUD - 增 查 改 删 - POST GET PUT DELETE</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.post(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">"CREATE"</span>) &#125;);</div><div class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">"READ"</span>) &#125;);</div><div class="line">app.put(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">"UPDATE"</span>) &#125;);</div><div class="line">app.delete(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">"DELETE"</span>) &#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>构建多版本API示例</p>
</li>
</ul>
<p>app1.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> api = express.Router();</div><div class="line"></div><div class="line">api.get(<span class="string">"/timezone"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">"Sample response for /timezone"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = api;</div></pre></td></tr></table></figure></p>
<p>app2.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> api = express.Router();</div><div class="line"></div><div class="line">api.get(<span class="string">"/timezone"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">"API 2: super cool new response for /timezone"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = api;</div></pre></td></tr></table></figure></p>
<p>app.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> apiVersion1 = <span class="built_in">require</span>(<span class="string">"./api1.js"</span>);</div><div class="line"><span class="keyword">var</span> apiVersion2 = <span class="built_in">require</span>(<span class="string">"./api2.js"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line">app.use(<span class="string">"/v1"</span>, apiVersion1);</div><div class="line">app.use(<span class="string">"/v2"</span>, apiVersion2);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"App started on port 3000"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>测试：<br><a href="http://localhost:3000/v1/timezone" target="_blank" rel="external">http://localhost:3000/v1/timezone</a><br>输出：Sample response for /timezone</p>
<p><a href="http://localhost:3000/v2/timezone" target="_blank" rel="external">http://localhost:3000/v2/timezone</a><br>输出：API 2: super cool new response for /timezone</p>
<ul>
<li>Http 状态码简述</li>
</ul>
<table>
<thead>
<tr>
<th>码段</th>
<th>描述</th>
<th>中文</th>
</tr>
</thead>
<tbody>
<tr>
<td>1xx</td>
<td>hold on</td>
<td>请求已接收，请求者还要继续发送</td>
</tr>
<tr>
<td>2xx</td>
<td>here you go</td>
<td>成功</td>
</tr>
<tr>
<td>3xx</td>
<td>go away</td>
<td>重定向</td>
</tr>
<tr>
<td>4xx</td>
<td>you messed up</td>
<td>客户端错误</td>
</tr>
<tr>
<td>5xx</td>
<td>I messed up</td>
<td>服务器错误</td>
</tr>
</tbody>
</table>
<h2 id="第七章-Views-and-templates-Pug-and-Ejs"><a href="#第七章-Views-and-templates-Pug-and-Ejs" class="headerlink" title="第七章 Views and templates, Pug and Ejs"></a>第七章 Views and templates, Pug and Ejs</h2><p><strong>关键词: jade, pug, ejs</strong></p>
<ul>
<li><p>视图引擎<br>用来渲染界面的模块，Pug和Ejs都是视图引擎</p>
</li>
<li><p>简单的利用视图引擎渲染的示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line">app.set(<span class="string">"view engine"</span>, ejs);</div><div class="line">app.set(<span class="string">"views"</span>, path.resolve(__dirname, <span class="string">"views"</span>));</div><div class="line"></div><div class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">"index"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这样当你访问 <a href="http://localhost:3000/" target="_blank" rel="external">http://localhost:3000/</a> 时候，Nodejs 会寻找 views 目录下的 index.ejs 文件进行渲染，并将结果发送给浏览器。</p>
<ul>
<li>从pug到html</li>
</ul>
<p>pug的源文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html(lang="en")</div><div class="line">  head</div><div class="line">    title Hello world!</div><div class="line">  body</div><div class="line">    h1 This is a pug example</div><div class="line">    #container</div><div class="line">      p Wow</div></pre></td></tr></table></figure></p>
<p>渲染后的结果<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello world!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is a pug example<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Wow.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>关于 Pug 本身的内容，以后再详细介绍。简单说来，pug就是利用缩进来区分区块的层级，用每行的地一个单词表示区块的标签，用空格引出区块的文本内容，用括号指定其属性。</p>
<h1 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h1><h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><p><strong>关键词: MongoDB, bcrypt, 认证</strong></p>
<ul>
<li>MongoDB 怎么样？</li>
</ul>
<ol>
<li>特别适合Node开发者</li>
<li>NoSQL数据库与JS对象的结构更相近</li>
<li>Mongo的原生shell使用的是Javascript</li>
<li>Application 1-&gt;1 Database 1-&gt;N Collection 1-&gt;N Document</li>
</ol>
<ul>
<li>从SQL到NoSQL(MongoDB)</li>
</ul>
<ol>
<li>MongoDB 的 Documents 相当于 SQL 的结果集，比如应用中的用户，每个用户就是个Document或者是SQL中的一行数据，MongoDB并不限制Schema</li>
<li>MongoDB 的 Collections 相当于 SQL 中的 tables。Collections 包含多个 Documents。此外，Documents 可以绑定其他 Documents</li>
<li>MongoDB 的 Databases 相当与 SQL 的 Databases</li>
</ol>
<ul>
<li>MongoDB 的安装（Ubuntu、Mint）<br><a href="https://docs.mongodb.com/master/tutorial/install-mongodb-on-ubuntu/" target="_blank" rel="external">https://docs.mongodb.com/master/tutorial/install-mongodb-on-ubuntu/</a></li>
</ul>
<ol>
<li>sudo apt-key adv –keyserver hkp://keyserver.ubuntu.com:80 –recv 0C49F3730359A14518585931BC711F9BA15703C6</li>
<li>echo “deb [ arch=amd64,arm64 ] <a href="http://repo.mongodb.org/apt/ubuntu" target="_blank" rel="external">http://repo.mongodb.org/apt/ubuntu</a> xenial/mongodb-org/3.4 multiverse” | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list</li>
<li>sudo apt-get update</li>
<li>sudo apt-get install -y mongodb-org</li>
</ol>
<ul>
<li>MongoDB 的Shell命令</li>
</ul>
<ol>
<li>sudo service mongod start</li>
<li>sudo service mongod stop</li>
<li>sudo service mongod restart</li>
<li>查看启动状态：cat /var/log/mongodb/mongod.log</li>
</ol>
<ul>
<li>MongoDB 的卸载</li>
</ul>
<ol>
<li>sudo service mongod stop</li>
<li>sudo apt-get purge mongodb-org*</li>
<li>sudo rm -r /var/log/mongodb</li>
<li>sudo rm -r /var/lib/mongodb</li>
</ol>
<ul>
<li><p>构建一个简单的工程</p>
<ul>
<li><p>需求描述：</p>
<ol>
<li>首页，所有用户可见，可以查看用户信息</li>
<li>用户信息页显示用户昵称或用户名，注册日期，用户登录后可以编辑自己的信息</li>
<li>新用户注册页</li>
</ol>
</li>
<li><p>实现步骤</p>
<ol>
<li>package.json 中配置依赖包</li>
<li>定义数据模型 user.js<br>2.1 模型中增加保持密码的处理<br>2.2 模型中增加校验密码的处理<br>2.3 模型中增加返回属性的处理<br>2.4 模型发布为系统模块</li>
<li>增加路由配置文件 route.js</li>
<li>增加ejs模板</li>
<li>利用passport认证<br>5.1 设置passport中间件(3个Express中间件，1个第三方中间件，2个Passport中间件)<pre><code>body-parser: 解析HTML的表单
cookie-parser: 解析浏览器的Cookies
express-session: Express保存用户session
connect-flash: 显示错误信息
passport.initialize: 初始化passport模块
passport.session: 使用Passport会话
</code></pre>5.2 定义User的序列化与反序列化<pre><code>把User转换成_id
把_id转换回User
</code></pre>5.3 定义如何认证User，通过设置 Strategy 实现</li>
<li>在 app.js 中使用模型<br>6.1 增加一系列中间件</li>
</ol>
</li>
</ul>
<p><strong>代码</strong></p>
<ol>
<li><p>package.json<br>使用以下命令配置 package.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ npm init</div><div class="line">$ npm install bcrypt-nodejs --save</div><div class="line">$ npm install body-parser --save</div><div class="line">$ npm install connect-flash --save</div><div class="line">$ npm install cookie-parser --save</div><div class="line">$ npm install ejs --save</div><div class="line">$ npm install express --save</div><div class="line">$ npm install express-session --save</div><div class="line">$ npm install mongoose --save</div><div class="line">$ npm install passport --save</div><div class="line">$ npm install passport-local --save</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"men-demo-1"</span>,</div><div class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="string">"description"</span>: <span class="string">"MongoDB+Express+Nodejs"</span>,</div><div class="line">  <span class="string">"main"</span>: <span class="string">"app.js"</span>,</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"test"</span>: <span class="string">"node app"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"keywords"</span>: [</div><div class="line">    <span class="string">"mongoDB"</span>,</div><div class="line">    <span class="string">"express"</span>,</div><div class="line">    <span class="string">"nodejs"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"author"</span>: <span class="string">"Booker"</span>,</div><div class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: &#123;</div><div class="line">    <span class="string">"bcrypt-nodejs"</span>: <span class="string">"0.0.3"</span>,</div><div class="line">    <span class="string">"body-parser"</span>: <span class="string">"^1.15.2"</span>,</div><div class="line">    <span class="string">"connect-flash"</span>: <span class="string">"^0.1.1"</span>,</div><div class="line">    <span class="string">"cookie-parser"</span>: <span class="string">"^1.4.3"</span>,</div><div class="line">    <span class="string">"ejs"</span>: <span class="string">"^2.5.5"</span>,</div><div class="line">    <span class="string">"express"</span>: <span class="string">"^4.14.0"</span>,</div><div class="line">    <span class="string">"express-session"</span>: <span class="string">"^1.14.2"</span>,</div><div class="line">    <span class="string">"mongoose"</span>: <span class="string">"^4.7.6"</span>,</div><div class="line">    <span class="string">"passport"</span>: <span class="string">"^0.3.2"</span>,</div><div class="line">    <span class="string">"passport-local"</span>: <span class="string">"^1.0.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</div><div class="line"></div><div class="line"><span class="comment">// User 模型</span></div><div class="line"><span class="keyword">var</span> userSchema = mongoose.Schema(&#123;</div><div class="line">  <span class="attr">username</span>: &#123;<span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">unique</span>: <span class="literal">true</span>&#125;,</div><div class="line">  <span class="attr">password</span>: &#123;<span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</div><div class="line">  <span class="attr">createdAt</span>: &#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now&#125;,</div><div class="line">  <span class="attr">displayName</span>: <span class="built_in">String</span>,</div><div class="line">  <span class="attr">bio</span>: <span class="built_in">String</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 获取显示名称</span></div><div class="line">userSchema.methods.name = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.displayName || <span class="keyword">this</span>.username;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 加密密码，这里使用 bcrypt。</span></div><div class="line"><span class="keyword">var</span> bcrypt = <span class="built_in">require</span>(<span class="string">"bcrypt-nodejs"</span>);</div><div class="line"><span class="keyword">var</span> SALT_FACTOR = <span class="number">10</span>;</div><div class="line"></div><div class="line"><span class="comment">// 增加一个 Pre-Save，当数据写入数据库的时候，执行对密码明文的Hash</span></div><div class="line"><span class="keyword">var</span> noop = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// 这是一个空操作，用来补齐bcrypt.hash方法的参数</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">userSchema.pre(<span class="string">"save"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> user = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!user.isModified(<span class="string">"password"</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> done();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  bcrypt.genSalt(SALT_FACTOR, <span class="function"><span class="keyword">function</span>(<span class="params">err, salt</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(err) &#123; <span class="keyword">return</span> done(err); &#125;</div><div class="line">    bcrypt.hash(user.password, salt, noop, <span class="function"><span class="keyword">function</span>(<span class="params">err, hashedPassword</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span>(err) &#123; <span class="keyword">return</span> done(err); &#125;</div><div class="line">      user.password = hashedPassword;</div><div class="line">      done();</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 检查密码</span></div><div class="line"><span class="comment">// 使用bcrypt.compare 方法检查密码，比使用全等===更加安全，这样我们可以减少暴露出的信息，避免如时序攻击等。</span></div><div class="line">userSchema.methods.checkPassword = <span class="function"><span class="keyword">function</span>(<span class="params">guess, done</span>) </span>&#123;</div><div class="line">  bcrypt.compare(guess, <span class="keyword">this</span>.password, <span class="function"><span class="keyword">function</span>(<span class="params">err, isMatch</span>) </span>&#123;</div><div class="line">    done(err, isMatch);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 发布用户模块，供nodejs使用</span></div><div class="line"><span class="keyword">var</span> User = mongoose.model(<span class="string">"User"</span>, userSchema);</div><div class="line"><span class="built_in">module</span>.exports = User;</div></pre></td></tr></table></figure>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">"body-parser"</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">"cookie-parser"</span>);</div><div class="line"><span class="keyword">var</span> session  = <span class="built_in">require</span>(<span class="string">"express-session"</span>);</div><div class="line"><span class="keyword">var</span> flash = <span class="built_in">require</span>(<span class="string">"connect-flash"</span>);</div><div class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">"passport"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> routes = <span class="built_in">require</span>(<span class="string">"./router"</span>); <span class="comment">// 路由定义文件，我们把所有的路由定义都写在routes文件中。</span></div><div class="line"><span class="keyword">var</span> setUpPassport = <span class="built_in">require</span>(<span class="string">"./setuppassport"</span>); <span class="comment">// 授权令牌</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line">mongoose.connect(<span class="string">"mongodb://localhost:27017/test"</span>); <span class="comment">// 连接mongo数据库</span></div><div class="line"></div><div class="line">setUpPassport(); <span class="comment">// 初始化令牌程序</span></div><div class="line"></div><div class="line"><span class="comment">// 设置环境变量</span></div><div class="line">app.set(<span class="string">"port"</span>, process.env.PORT || <span class="number">3000</span>); <span class="comment">// 访问地址</span></div><div class="line">app.set(<span class="string">"views"</span>, path.join(__dirname, <span class="string">"views"</span>)); <span class="comment">// 页面模板目录</span></div><div class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"ejs"</span>); <span class="comment">// 模板类型</span></div><div class="line"></div><div class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;)); <span class="comment">// Form 表单数据的解析</span></div><div class="line">app.use(cookieParser()); <span class="comment">// 浏览器Cookie的解析</span></div><div class="line">app.use(session(&#123;</div><div class="line">  <span class="attr">secret</span>: <span class="string">"TKRv0IJs=HYqrvagQ#&amp;!F!%V]Ww/4KiVs$s,&lt;&lt;MX"</span>, <span class="comment">// 用于加密Session</span></div><div class="line">  resave: <span class="literal">true</span>, <span class="comment">// 即使 Session 未发生改变依然执行保存操作</span></div><div class="line">  saveUninitialized: <span class="literal">true</span> <span class="comment">// 即使 Session 未完成初始化也执行保持操作</span></div><div class="line">&#125;));</div><div class="line">app.use(flash()); <span class="comment">// 用于输出错误消息</span></div><div class="line"></div><div class="line">app.use(passport.initialize()); <span class="comment">// 令牌初始化</span></div><div class="line">app.use(passport.session()); <span class="comment">// 使令牌支持Session操作</span></div><div class="line"></div><div class="line">app.use(routes); <span class="comment">// 使用路由的定义</span></div><div class="line"></div><div class="line">app.listen(app.get(<span class="string">"port"</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"服务已启动，端口为："</span> + app.get(<span class="string">"port"</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>router.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</div><div class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">"passport"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> User = <span class="built_in">require</span>(<span class="string">"./models/user"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">// 在 response 中绑定基本属性</span></div><div class="line">router.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.locals.currentUser = req.user;</div><div class="line">  res.locals.errors = req.flash(<span class="string">"error"</span>);</div><div class="line">  res.locals.infos = req.flash(<span class="string">"info"</span>);</div><div class="line">  next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureAuthenticated</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span>(req.isAuthenticated()) &#123;</div><div class="line">    next();</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    req.flash(<span class="string">"info"</span>, <span class="string">"登录后可访问此页。"</span>);</div><div class="line">    res.redirect(<span class="string">"/login"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 查询用户，返回列表</span></div><div class="line">router.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  User.find()</div><div class="line">    .sort(&#123;<span class="attr">createdAt</span>: <span class="string">"descending"</span>&#125;)</div><div class="line">    .exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, users</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span>(err) &#123; <span class="keyword">return</span> next(err); &#125;</div><div class="line">      res.render(<span class="string">"index"</span>, &#123;<span class="attr">users</span>: users&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 进入注册页</span></div><div class="line">router.get(<span class="string">"/signup"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">"signup"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 接收注册提交的表单</span></div><div class="line">router.post(<span class="string">"/signup"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> username = req.body.username;</div><div class="line">  <span class="keyword">var</span> password = req.body.password;</div><div class="line"></div><div class="line">  User.findOne(&#123; <span class="attr">username</span>: username &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(err) &#123; <span class="keyword">return</span> next(err); &#125;</div><div class="line">    <span class="keyword">if</span>(user) &#123;</div><div class="line">      req.flash(<span class="string">"error"</span>, <span class="string">"用户已存在"</span>);</div><div class="line">      <span class="keyword">return</span> res.redirect(<span class="string">"/signup"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> newUser = <span class="keyword">new</span> User(&#123;</div><div class="line">      <span class="attr">username</span>: username,</div><div class="line">      <span class="attr">password</span>: password</div><div class="line">    &#125;);</div><div class="line">    newUser.save(next);</div><div class="line">  &#125;);</div><div class="line">&#125;, passport.authenticate(<span class="string">"login"</span>, &#123;</div><div class="line">  <span class="attr">successRedirect</span>: <span class="string">"/"</span>,</div><div class="line">  <span class="attr">failureRedirect</span>: <span class="string">"/signup"</span>,</div><div class="line">  <span class="attr">failureFlash</span>: <span class="literal">true</span></div><div class="line">&#125;));</div><div class="line"></div><div class="line">router.get(<span class="string">"/login"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">"login"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.post(<span class="string">"/login"</span>, passport.authenticate(<span class="string">"login"</span>, &#123;</div><div class="line">  <span class="attr">successRedirect</span>: <span class="string">"/"</span>,</div><div class="line">  <span class="attr">failureRedirect</span>: <span class="string">"/login"</span>,</div><div class="line">  <span class="attr">failureFlash</span>: <span class="literal">true</span></div><div class="line">&#125;));</div><div class="line"></div><div class="line">router.get(<span class="string">"logout"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  req.logout();</div><div class="line">  res.redirect(<span class="string">"/"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.get(<span class="string">"/users/:username"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  User.findOne(&#123;<span class="attr">username</span>:req.params.username&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(err) &#123;<span class="keyword">return</span> next(err);&#125;</div><div class="line">    <span class="keyword">if</span>(!user) &#123;<span class="keyword">return</span> next(<span class="number">404</span>);&#125;</div><div class="line">    res.render(<span class="string">"profile"</span>, &#123;<span class="attr">user</span>: user&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.get(<span class="string">"/edit"</span>, ensureAuthenticated, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">"edit"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.post(<span class="string">"/edit"</span>, ensureAuthenticated, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  req.user.displayName = req.body.displayname;</div><div class="line">  req.user.bio = req.body.bio;</div><div class="line">  req.user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(err) &#123;</div><div class="line">      next(err);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    req.flash(<span class="string">"info"</span>, <span class="string">"个人信息已更新"</span>);</div><div class="line">    res.redirect(<span class="string">"/edit"</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure>
</li>
<li><p>setuppassport.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">"passport"</span>);</div><div class="line"><span class="keyword">var</span> User = <span class="built_in">require</span>(<span class="string">"./models/user"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> LocalStrategy = <span class="built_in">require</span>(<span class="string">"passport-local"</span>).Strategy;</div><div class="line"></div><div class="line">passport.use(<span class="string">"login"</span>, <span class="keyword">new</span> LocalStrategy(<span class="function"><span class="keyword">function</span>(<span class="params">username, password, done</span>) </span>&#123;</div><div class="line">  User.findOne(&#123; <span class="attr">username</span>: username &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> done(err); &#125;</div><div class="line">    <span class="keyword">if</span> (!user) &#123;</div><div class="line">      <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>, &#123;<span class="attr">message</span>: <span class="string">"No user has that username!"</span> &#125;);</div><div class="line">    &#125;</div><div class="line">    user.checkPassword(password, <span class="function"><span class="keyword">function</span>(<span class="params">err, isMatch</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> done(err); &#125;</div><div class="line">      <span class="keyword">if</span> (isMatch) &#123;</div><div class="line">        <span class="keyword">return</span> done(<span class="literal">null</span>, user);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">false</span>, &#123; <span class="attr">message</span>: <span class="string">"Invalid password."</span> &#125;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, done</span>) </span>&#123;</div><div class="line">    done(<span class="literal">null</span>, user._id);</div><div class="line">  &#125;);</div><div class="line">  passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">id, done</span>) </span>&#123;</div><div class="line">    User.findById(id, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</div><div class="line">      done(err, user);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>Views 中的各文件</p>
<p>6.1 _header.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>MEN简单完整示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar navbar-default navbar-static-top"</span> <span class="attr">role</span>=<span class="string">"navigation"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar-header"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>学习 MEN<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav navbar-right"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">currentUser</span>) &#123; %&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">li</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/edit"</span>&gt;</span></div><div class="line">              Hello, <span class="tag">&lt;<span class="name">%=</span> <span class="attr">currentUser.name</span>() %&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/logout"</span>&gt;</span>登出<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">%</span> &#125; <span class="attr">else</span> &#123; %&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/login"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/signup"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">%</span> <span class="attr">errors.forEach</span>(<span class="attr">function</span>(<span class="attr">error</span>) &#123; %&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-danger"</span> <span class="attr">role</span>=<span class="string">"alert"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">%=</span> <span class="attr">error</span> %&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">%</span> &#125;) %&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">%</span> <span class="attr">infos.forEach</span>(<span class="attr">function</span>(<span class="attr">info</span>) &#123; %&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-info"</span> <span class="attr">role</span>=<span class="string">"alert"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">%=</span> <span class="attr">info</span> %&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">%</span> &#125;) %&gt;</span></div></pre></td></tr></table></figure>
<p>6.2 _footer.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>6.3 index.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_header</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>开始学习MEN<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">users.forEach</span>(<span class="attr">function</span>(<span class="attr">user</span>) &#123; %&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/users/&lt;%= user.username %&gt;"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">%=</span> <span class="attr">user.name</span>() %&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">user.bio</span>) &#123; %&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">user.bio</span> %&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">%</span> &#125;) %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_footer</span> %&gt;</span></div></pre></td></tr></table></figure>
<p>6.4 profile.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_header</span> %&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span>((<span class="attr">currentUser</span>) &amp;&amp; (<span class="attr">currentUser.id</span> === <span class="string">user.id))</span> &#123; %&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/edit"</span> <span class="attr">class</span>=<span class="string">"pull-right"</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">user.name</span>() %&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>注册时间 <span class="tag">&lt;<span class="name">%=</span> <span class="attr">user.createdAt</span> %&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span>(<span class="attr">user.bio</span>) &#123; %&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">user.bio</span> %&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_footer</span> %&gt;</span></div></pre></td></tr></table></figure>
<p>6.5 signup.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_header</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Sign up<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/signup"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span></span></div><div class="line"><span class="attr">placeholder</span>=<span class="string">"Username"</span> <span class="attr">required</span> <span class="attr">autofocus</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span></span></div><div class="line"><span class="attr">placeholder</span>=<span class="string">"Password"</span> <span class="attr">required</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Sign up"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-block"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_footer</span> %&gt;</span></div></pre></td></tr></table></figure>
<p>6.6 login.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_header</span> %&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"登录名"</span> <span class="attr">required</span>=<span class="string">"required"</span> <span class="attr">autofocus</span>=<span class="string">"autofocus"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"密  码"</span> <span class="attr">required</span>=<span class="string">"required"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登录"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-block"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_footer</span> %&gt;</span></div></pre></td></tr></table></figure>
<p>6.7 edit.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_header</span> %&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>编辑个人信息<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/edit"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"displayname"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"昵称"</span> <span class="attr">value</span>=<span class="string">"&lt;%= currentUser.displayName || "</span>" %&gt;</span>"&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"bio"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"个人描述"</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">currentUser.bio</span> %&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"更新"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-block"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">include</span> <span class="attr">_footer</span> %&gt;</span></div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<h1 id="Express的测试"><a href="#Express的测试" class="headerlink" title="Express的测试"></a>Express的测试</h1><ul>
<li><p>什么是TDD？<br>TDD 是 test-driver development 的缩写，也就是有测试驱动开发。即比如我们要实现一套API，在开始写API代码之前，就应该先把对应的单元测试写好。</p>
</li>
<li><p>TDD如何工作？<br>编写测试用例-&gt;实现代码，保证每个测试用例都可以通过-&gt;优化代码-&gt;回到第一步如此循环。</p>
</li>
<li><p>Nodejs 如何测试？<br>常见的测试框架有：Mocha（这个框架用来自动执行测试用例），Chai（这是个断言框架，是用来辅助自动化测试的）</p>
</li>
<li><p>Mocha + Chai 的简单示例</p>
<p><strong>目录结构</strong></p>
<ol>
<li>package.json</li>
<li>capitalize.js 待测试的模块</li>
<li>test/capitalize.js 单元测试代码</li>
</ol>
<p>package.json</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"Chai-1"</span>,</div><div class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="string">"description"</span>: <span class="string">""</span>,</div><div class="line">  <span class="string">"main"</span>: <span class="string">"app.js"</span>,</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"test"</span>: <span class="string">"mocha"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"author"</span>: <span class="string">"Booker"</span>,</div><div class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: &#123;</div><div class="line">    <span class="string">"chai"</span>: <span class="string">"^3.5.0"</span>,</div><div class="line">    <span class="string">"mocha"</span>: <span class="string">"^3.2.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>capitalize.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">capitalize</span>(<span class="params">str</span>) </span>&#123;</div><div class="line">  <span class="comment">//var firstLetter = str[0].toUpperCase(); // 空字符串时会报错</span></div><div class="line">  <span class="keyword">var</span> firstLetter = str.charAt(<span class="number">0</span>).toUpperCase(); <span class="comment">// 空字符串不会报错</span></div><div class="line">  <span class="keyword">var</span> rest = str.slice(<span class="number">1</span>).toLowerCase();</div><div class="line">  <span class="keyword">return</span> firstLetter + rest;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = capitalize;</div></pre></td></tr></table></figure>
<p>test/capitalize.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> chai = <span class="built_in">require</span>(<span class="string">"chai"</span>); <span class="comment">// 断言框架</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> capitalize = <span class="built_in">require</span>(<span class="string">"../capitalize"</span>); <span class="comment">// 待测试的模块</span></div><div class="line"><span class="keyword">var</span> expect = chai.expect;</div><div class="line"></div><div class="line">describe(<span class="string">"大小写转换测试"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"每个Test之前会被执行."</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">	it(<span class="string">"一个单词大小写"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		expect(capitalize(<span class="string">"express"</span>)).to.equal(<span class="string">"Express"</span>);</div><div class="line">		expect(capitalize(<span class="string">"cats"</span>)).to.equal(<span class="string">"Cats"</span>);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	it(<span class="string">"两个单词的大小写"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		expect(capitalize(<span class="string">"express one"</span>)).to.equal(<span class="string">"Express one"</span>);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	it(<span class="string">"空字符串"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		expect(capitalize(<span class="string">""</span>)).to.equal(<span class="string">""</span>);</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">  it(<span class="string">"没有字母"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    expect(capitalize(<span class="string">"   "</span>)).to.equal(<span class="string">"   "</span>);</div><div class="line">    expect(capitalize(<span class="string">"123"</span>)).to.equal(<span class="string">"123"</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  it(<span class="string">"字符串对象"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> str = <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">"who am I"</span>);</div><div class="line">    expect(capitalize(str)).to.equal(<span class="string">"Who am i"</span>);</div><div class="line">    expect(str.valueOf()).to.equal(<span class="string">"who am I"</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  it(<span class="string">"测试抛出异常"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    expect(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;capitalize(<span class="number">123</span>); &#125;).to.throw(<span class="built_in">Error</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  it(<span class="string">"测试非的情况"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    expect(capitalize(<span class="string">"foo"</span>)).not.to.equal(<span class="string">"foo"</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>使用 SuperTest 测试 API<br><strong>步骤:</strong></p>
<ol>
<li><p>初始化package.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">npm init</div><div class="line">...</div><div class="line">npm install express --save</div><div class="line">npm install ejs --save</div><div class="line">npm install cheerio --save-dev</div><div class="line">npm install mocha --save-dev</div><div class="line">npm install supertest --save-dev</div></pre></td></tr></table></figure>
<p>其中,cheerio 用来解析html文件, supertest 用来发送http请求.</p>
<p>完成后的 package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"supertest-1"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"使用 SuperTest 测试 API"</span>,</div><div class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"app.js"</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"start"</span>: <span class="string">"node app"</span>,</div><div class="line">    <span class="attr">"test"</span>: <span class="string">"mocha"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"author"</span>: <span class="string">"Booker"</span>,</div><div class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</div><div class="line">  <span class="attr">"dependencies"</span>: &#123;</div><div class="line">    <span class="attr">"ejs"</span>: <span class="string">"^2.5.5"</span>,</div><div class="line">    <span class="attr">"express"</span>: <span class="string">"^4.14.0"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"cheerio"</span>: <span class="string">"^0.22.0"</span>,</div><div class="line">    <span class="attr">"mocha"</span>: <span class="string">"^3.2.0"</span>,</div><div class="line">    <span class="attr">"supertest"</span>: <span class="string">"^2.0.1"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>构建测试架构<br>这里我们要测试的内容包括字符类型的API, 还有ejs生成的页面</p>
</li>
<li>做一个简单的API服务</li>
</ol>
</li>
</ul>
<link href="/css/prism.css" rel="stylesheet">

            
            <div class="post-reward">
                <a id="rewardBtn" href="javascript:;" class="post-reward-btn waves-effect waves-circle waves-light">赏</a>
            </div>
            
            
            <blockquote>
                <p>
                本文地址：
                <a href="http://tonglei.win/2017/01/03/IT学习/Javascript/express-in-action-笔记/" target="_blank" rel="external">http://tonglei.win/2017/01/03/IT学习/Javascript/express-in-action-笔记/</a>
                </p>
                <footer><cite><a href="http://tonglei.win">@铜镭</a></cite></footer>
            </blockquote>
            </div>
            
<nav class="post-nav">
  
    <div class="waves-block waves-effect prev fl">
      <a href="/2017/02/20/IT学习/Javascript/hexo-源码学习-准备/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">hexo-源码学习-准备</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2016/12/28/日常记录/史上最全最强资源网站整理/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">史上最全最强资源网站整理</h4>
      </a>
    </div>
  
</nav>


            
            
<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="IT学习/Javascript/express-in-action-笔记" data-title="express-in-action_笔记" data-url="http://tonglei.win/2017/01/03/IT学习/Javascript/express-in-action-笔记/index.html"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"tonglei"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





        </div>
    </div>
</article>
    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>
var BLOG_SHARE = {
    title: "express-in-action_笔记",
    pic: "/img/logo.jpg",
    summary: document.getElementsByName('summary')[0].content,
    url: "http://tonglei.win/2017/01/03/IT学习/Javascript/express-in-action-笔记/index.html"
};
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>




<div id="reward" class="reward-lay">
    <a class="reward-off" id="rewardOff" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        点确定别犹豫！
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechat.png" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.png" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>

<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/js/search.js"></script>









<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?8b11206e714935934a6674b4a55ea783";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



</body>
</html>
